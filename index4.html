import React, { useState, useEffect } from 'react';
import { 
  Clock, AlertTriangle, CheckCircle, XCircle, ChevronRight, 
  ChevronLeft, Award, RefreshCcw, Brain, Target, BarChart2,
  HelpCircle, Zap
} from 'lucide-react';

const AnalogyTest = () => {
  // --- Game State ---
  const [gameState, setGameState] = useState('start'); // start, quiz, result
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [answers, setAnswers] = useState({});
  const [timeLeft, setTimeLeft] = useState(20 * 60);
  const [showExplanation, setShowExplanation] = useState(false);

  // --- Constants ---
  const TOTAL_QUESTIONS = 20;
  const POSITIVE_MARK = 1;
  const NEGATIVE_MARK = 1/3;

  // --- Questions Data (Hard Level) ---
  const questions = [
    {
      id: 1,
      question: "6 : 222 :: 7 : ?",
      options: ["343", "350", "336", "210"],
      correctAnswer: "350",
      logic: "Logic: n³ + n. (6³ + 6 = 222), इसी प्रकार (7³ + 7 = 350)."
    },
    {
      id: 2,
      question: "न्यूमिज़माटिक्स : सिक्के :: ? : पत्थर",
      options: ["ओरोलॉजी (Orology)", "लिथोलॉजी (Lithology)", "पैलियोन्टोलॉजी", "इकोलॉजी"],
      correctAnswer: "लिथोलॉजी (Lithology)",
      logic: "सिक्कों के अध्ययन को न्यूमिज़माटिक्स कहते हैं, पत्थरों के अध्ययन को लिथोलॉजी कहते हैं।"
    },
    {
      id: 3,
      question: "123 : 36 :: 221 : ?",
      options: ["25", "52", "69", "72"],
      correctAnswer: "25",
      logic: "अंकों का योग और उसका वर्ग। (1+2+3)² = 36. (2+2+1)² = 25."
    },
    {
      id: 4,
      question: "CAT : 3120 :: MAT : ?",
      options: ["13120", "132620", "12120", "130120"],
      correctAnswer: "13120",
      logic: "C=3, A=1, T=20 -> 3120. M=13, A=1, T=20 -> 13120."
    },
    {
      id: 5,
      question: "ईरान : मजलिस :: बुल्गारिया : ?",
      options: ["डाइट्स", "स्टोर्टिंग", "नरोदनो सबरानी", "सोगडू"],
      correctAnswer: "नरोदनो सबरानी",
      logic: "देश और उनकी संसद। ईरान: मजलिस, बुल्गारिया: नरोदनो सबरानी।"
    },
    {
      id: 6,
      question: "48 : 122 :: 168 : ?",
      options: ["292", "290", "225", "215"],
      correctAnswer: "290",
      logic: "अभाज्य संख्याओं का वर्ग +/- 1. (7²-1) : (11²+1) :: (13²-1) : (17²+1)."
    },
    {
      id: 7,
      question: "ऊर्जा : जूल :: पास्कल : ?",
      options: ["दबाव (Pressure)", "शक्ति (Power)", "बल (Force)", "प्रतिरोध"],
      correctAnswer: "दबाव (Pressure)",
      logic: "जूल ऊर्जा की इकाई है, पास्कल दबाव की इकाई है।"
    },
    {
      id: 8,
      question: "FILM : ADGH :: MILK : ?",
      options: ["ADGF", "HDGF", "HEGF", "HDGE"],
      correctAnswer: "HDGF",
      logic: "हर अक्षर में -5 का अंतर है। M-5=H, I-5=D, L-5=G, K-5=F."
    },
    {
      id: 9,
      question: "5 : 100 :: 7 : ?",
      options: ["49", "196", "91", "149"],
      correctAnswer: "196",
      logic: "Logic: (n² × 4). 25×4=100. 49×4=196."
    },
    {
      id: 10,
      question: "अकादमिक : पेडागोगी :: धर्म : ?",
      options: ["धर्मशास्त्र (Theology)", "मनोविज्ञान", "दर्शनशास्त्र", "समाजशास्त्र"],
      correctAnswer: "धर्मशास्त्र (Theology)",
      logic: "अकादमिक अध्ययन: शिक्षाशास्त्र, धर्म का अध्ययन: धर्मशास्त्र।"
    },
    {
      id: 11,
      question: "B : 16 :: D : ?",
      options: ["64", "256", "128", "32"],
      correctAnswer: "256",
      logic: "स्थान का मान की घात 4. B=2, 2⁴=16. D=4, 4⁴=256."
    },
    {
      id: 12,
      question: "हृदय : कार्डियोलॉजिस्ट :: वृक्क (Kidney) : ?",
      options: ["न्यूरोलॉजिस्ट", "नेफ्रोलॉजिस्ट", "ऑर्थोडॉन्टिस्ट", "ओन्कोलॉजिस्ट"],
      correctAnswer: "नेफ्रोलॉजिस्ट",
      logic: "किडनी के डॉक्टर को नेफ्रोलॉजिस्ट कहते हैं।"
    },
    {
      id: 13,
      question: "18 : 30 :: 36 : ?",
      options: ["64", "66", "54", "62"],
      correctAnswer: "66",
      logic: "Logic: (n × 2) - 6. (18×2)-6 = 30. (36×2)-6 = 66."
    },
    {
      id: 14,
      question: "शीतलता : शीतलक :: ? : ? ",
      options: ["आर्द्रता : थर्मामीटर", "दबाव : बैरोमीटर", "मोटाई : कैलिपर", "गर्मी : हीटर"],
      correctAnswer: "गर्मी : हीटर",
      logic: "शीतलक शीतलता प्रदान करता है, हीटर गर्मी प्रदान करता है।"
    },
    {
      id: 15,
      question: "MK : 169/121 :: JH : ?",
      options: ["100/64", "100/81", "81/64", "64/100"],
      correctAnswer: "100/64",
      logic: "स्थान का वर्ग। M=13²=169, K=11²=121. J=10²=100, H=8²=64."
    },
    {
      id: 16,
      question: "बाघ : फेलिडाई (Felidae) :: खरगोश : ?",
      options: ["लेपोरिडे (Leporidae)", "कैनिडे", "बोविडे", "इक्विडे"],
      correctAnswer: "लेपोरिडे (Leporidae)",
      logic: "खरगोश लेपोरिडे परिवार से है।"
    },
    {
      id: 17,
      question: "42 : 56 :: 72 : ?",
      options: ["81", "90", "92", "100"],
      correctAnswer: "90",
      logic: "क्रमिक संख्या गुणन। 6×7, 7×8... 8×9, 9×10=90."
    },
    {
      id: 18,
      question: "विजय : प्रोत्साहन :: विफलता : ?",
      options: ["उदासी", "हताशा (Frustration)", "क्रोध", "चिंता"],
      correctAnswer: "हताशा (Frustration)",
      logic: "विजय से प्रोत्साहन, विफलता से हताशा।"
    },
    {
      id: 19,
      question: "AZCX : BYDW :: HQJO : ?",
      options: ["GRFP", "IPKN", "GREP", "ISKP"],
      correctAnswer: "IPKN",
      logic: "+1, -1 पैटर्न। A+1=B, Z-1=Y... H+1=I, Q-1=P, J+1=K, O-1=N."
    },
    {
      id: 20,
      question: "पाइरोफोबिया : आग :: ओक्लोफोबिया : ?",
      options: ["भीड़ (Crowd)", "ऊंचाई", "अंधेरा", "विदेशी"],
      correctAnswer: "भीड़ (Crowd)",
      logic: "पाइरोफोबिया आग का डर, ओक्लोफोबिया भीड़ का डर।"
    }
  ];

  // --- Helpers ---
  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
  };

  const handleStart = () => {
    setGameState('quiz');
    setTimeLeft(20 * 60);
  };

  const handleAnswer = (option) => {
    setAnswers({ ...answers, [questions[currentQuestion].id]: option });
  };

  const handleSubmit = () => {
    setGameState('result');
  };

  // --- Timer ---
  useEffect(() => {
    if (gameState === 'quiz' && timeLeft > 0) {
      const timerId = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
      return () => clearTimeout(timerId);
    } else if (timeLeft === 0 && gameState === 'quiz') {
      handleSubmit();
    }
  }, [timeLeft, gameState]);

  // --- Score Calc ---
  const calculateResult = () => {
    let correct = 0;
    let incorrect = 0;
    questions.forEach(q => {
      const ans = answers[q.id];
      if (ans) {
        if (ans === q.correctAnswer) correct++;
        else incorrect++;
      }
    });
    const rawScore = (correct * POSITIVE_MARK) - (incorrect * NEGATIVE_MARK);
    return {
      correct,
      incorrect,
      unattempted: TOTAL_QUESTIONS - (correct + incorrect),
      score: rawScore.toFixed(2),
      accuracy: correct + incorrect > 0 ? Math.round((correct / (correct + incorrect)) * 100) : 0
    };
  };

  // --- Components ---

  // 1. Background Wrapper
  const Background = ({ children }) => (
    <div className="min-h-screen bg-[#09090b] text-white font-sans selection:bg-indigo-500 selection:text-white relative overflow-hidden">
      {/* Ambient Glows */}
      <div className="fixed top-[-10%] left-[-10%] w-[40%] h-[40%] bg-purple-900/20 rounded-full blur-[120px] pointer-events-none" />
      <div className="fixed bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-indigo-900/20 rounded-full blur-[120px] pointer-events-none" />
      <div className="relative z-10 w-full h-full">
        {children}
      </div>
    </div>
  );

  // 2. Start Screen
  const StartScreen = () => (
    <div className="flex flex-col items-center justify-center min-h-screen p-6">
      <div className="max-w-3xl w-full bg-gray-900/40 backdrop-blur-2xl border border-white/10 rounded-3xl p-8 md:p-12 shadow-2xl flex flex-col items-center text-center relative overflow-hidden group">
        
        {/* Decorative Top Line */}
        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500 to-transparent opacity-50"></div>

        <div className="mb-8 relative">
          <div className="absolute inset-0 bg-indigo-500 blur-3xl opacity-20 rounded-full"></div>
          <Brain className="w-20 h-20 text-indigo-400 relative z-10 drop-shadow-[0_0_15px_rgba(129,140,248,0.5)]" />
        </div>

        <h1 className="text-5xl md:text-7xl font-extrabold tracking-tight mb-4 text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-400">
          Analogy<span className="text-indigo-500">Pro</span>
        </h1>
        <p className="text-lg md:text-xl text-gray-400 max-w-lg mb-10 leading-relaxed">
          हाई-लेवल रीजनिंग टेस्ट। 20 कठिन प्रश्न, नेगेटिव मार्किंग और सीमित समय। क्या आप तैयार हैं?
        </p>

        {/* Info Grid */}
        <div className="grid grid-cols-3 gap-4 md:gap-8 w-full mb-12">
          {[
            { icon: Clock, label: "20 Min", sub: "Time Limit", color: "text-blue-400" },
            { icon: Target, label: "20 Qs", sub: "Hard Level", color: "text-purple-400" },
            { icon: AlertTriangle, label: "-0.33", sub: "Negative", color: "text-rose-400" }
          ].map((item, idx) => (
            <div key={idx} className="flex flex-col items-center p-4 bg-white/5 rounded-2xl border border-white/5 hover:bg-white/10 transition-colors">
              <item.icon className={`w-6 h-6 mb-2 ${item.color}`} />
              <span className="text-xl font-bold">{item.label}</span>
              <span className="text-xs text-gray-500 uppercase tracking-wider">{item.sub}</span>
            </div>
          ))}
        </div>

        <button 
          onClick={handleStart}
          className="group relative px-8 py-4 bg-indigo-600 rounded-full text-white font-bold text-lg tracking-wide overflow-hidden shadow-[0_0_40px_-10px_rgba(79,70,229,0.5)] transition-all hover:scale-105 hover:shadow-[0_0_60px_-15px_rgba(79,70,229,0.6)]"
        >
          <span className="relative z-10 flex items-center">
            टेस्ट शुरू करें <ChevronRight className="ml-2 w-5 h-5 group-hover:translate-x-1 transition-transform" />
          </span>
          <div className="absolute inset-0 bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        </button>
      </div>
    </div>
  );

  // 3. Quiz Screen
  const QuizScreen = () => {
    const q = questions[currentQuestion];
    const progress = ((currentQuestion + 1) / TOTAL_QUESTIONS) * 100;

    return (
      <div className="flex flex-col min-h-screen">
        {/* Header */}
        <header className="sticky top-0 z-30 bg-[#09090b]/80 backdrop-blur-md border-b border-white/5">
          <div className="max-w-6xl mx-auto px-6 h-20 flex justify-between items-center">
             <div className="flex items-center gap-4">
                <div className="bg-indigo-600/20 p-2 rounded-lg">
                  <Brain className="w-6 h-6 text-indigo-400" />
                </div>
                <div>
                   <h2 className="text-sm text-gray-400 uppercase tracking-widest font-bold">Question</h2>
                   <p className="text-xl font-mono font-bold text-white">{currentQuestion + 1}<span className="text-gray-600 mx-1">/</span>{TOTAL_QUESTIONS}</p>
                </div>
             </div>

             <div className={`flex items-center gap-3 px-5 py-2 rounded-full border ${timeLeft < 60 ? 'bg-red-500/10 border-red-500/50 text-red-400 animate-pulse' : 'bg-gray-800 border-gray-700 text-gray-200'}`}>
                <Clock size={18} />
                <span className="font-mono text-xl font-bold tracking-widest">{formatTime(timeLeft)}</span>
             </div>
          </div>
          {/* Slim Progress Bar */}
          <div className="h-[2px] w-full bg-gray-800">
             <div className="h-full bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.8)] transition-all duration-500 ease-out" style={{ width: `${progress}%` }}></div>
          </div>
        </header>

        {/* Main Content */}
        <main className="flex-1 flex flex-col items-center justify-center p-4 md:p-8 max-w-5xl mx-auto w-full">
           <div className="w-full bg-gray-900/50 backdrop-blur-xl border border-white/10 rounded-3xl p-6 md:p-10 shadow-2xl">
              
              {/* Question Text */}
              <div className="mb-10">
                 <h2 className="text-2xl md:text-4xl font-bold leading-normal text-white drop-shadow-sm">
                   {q.question}
                 </h2>
              </div>

              {/* Options Grid */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                 {q.options.map((opt, idx) => {
                    const isSelected = answers[q.id] === opt;
                    return (
                      <button
                        key={idx}
                        onClick={() => handleAnswer(opt)}
                        className={`group relative p-5 md:p-6 text-left rounded-2xl border transition-all duration-300
                          ${isSelected 
                            ? 'bg-indigo-600/20 border-indigo-500/50 shadow-[0_0_30px_-5px_rgba(79,70,229,0.3)]' 
                            : 'bg-gray-800/40 border-white/5 hover:bg-gray-800 hover:border-white/10'
                          }
                        `}
                      >
                         <div className="flex justify-between items-center">
                            <span className={`text-lg md:text-xl font-medium ${isSelected ? 'text-white' : 'text-gray-300 group-hover:text-white'}`}>
                              {opt}
                            </span>
                            {isSelected && <div className="w-3 h-3 bg-indigo-400 rounded-full shadow-[0_0_10px_rgba(129,140,248,1)]"></div>}
                         </div>
                      </button>
                    )
                 })}
              </div>
           </div>
        </main>

        {/* Footer Actions */}
        <footer className="py-6 px-6 max-w-5xl mx-auto w-full flex justify-between items-center">
            <button
               onClick={() => setCurrentQuestion(prev => Math.max(0, prev - 1))}
               disabled={currentQuestion === 0}
               className={`flex items-center px-6 py-3 rounded-xl font-semibold transition-all
                  ${currentQuestion === 0 ? 'opacity-0 pointer-events-none' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}
            >
               <ChevronLeft className="mr-2" /> पिछला
            </button>

            {currentQuestion === TOTAL_QUESTIONS - 1 ? (
               <button
                  onClick={handleSubmit}
                  className="flex items-center px-10 py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-2xl font-bold shadow-lg shadow-emerald-900/40 transform hover:-translate-y-1 transition-all"
               >
                  सबमिट करें <CheckCircle className="ml-2" />
               </button>
            ) : (
               <button
                  onClick={() => setCurrentQuestion(prev => Math.min(TOTAL_QUESTIONS - 1, prev + 1))}
                  className="flex items-center px-10 py-4 bg-white text-black hover:bg-gray-200 rounded-2xl font-bold shadow-lg shadow-white/10 transform hover:-translate-y-1 transition-all"
               >
                  अगला <ChevronRight className="ml-2" />
               </button>
            )}
        </footer>
      </div>
    );
  };

  // 4. Result Screen
  const ResultScreen = () => {
    const res = calculateResult();
    const isPass = parseFloat(res.score) > 10;

    return (
      <div className="min-h-screen p-6 md:p-12 max-w-6xl mx-auto">
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
           
           {/* Left Column: Summary Card */}
           <div className="lg:col-span-5 flex flex-col gap-6">
              <div className="bg-gray-900/60 backdrop-blur-xl border border-white/10 rounded-3xl p-8 shadow-2xl text-center relative overflow-hidden">
                 <div className={`absolute top-0 w-full h-2 left-0 ${isPass ? 'bg-emerald-500' : 'bg-red-500'}`}></div>
                 
                 <h2 className="text-gray-400 uppercase tracking-widest text-sm font-bold mb-6">Total Score</h2>
                 <div className="relative inline-block mb-6">
                    <div className={`text-7xl font-bold tracking-tighter ${isPass ? 'text-white' : 'text-white'}`}>
                       {res.score}
                    </div>
                    <div className="text-gray-500 font-medium mt-2">out of 20.00</div>
                 </div>

                 <div className="grid grid-cols-3 gap-2 mb-8">
                    <div className="p-3 bg-emerald-500/10 rounded-xl border border-emerald-500/20">
                       <div className="text-2xl font-bold text-emerald-400">{res.correct}</div>
                       <div className="text-xs text-emerald-200/50 uppercase">Correct</div>
                    </div>
                    <div className="p-3 bg-rose-500/10 rounded-xl border border-rose-500/20">
                       <div className="text-2xl font-bold text-rose-400">{res.incorrect}</div>
                       <div className="text-xs text-rose-200/50 uppercase">Wrong</div>
                    </div>
                    <div className="p-3 bg-gray-700/30 rounded-xl border border-white/5">
                       <div className="text-2xl font-bold text-gray-300">{res.unattempted}</div>
                       <div className="text-xs text-gray-500 uppercase">Skip</div>
                    </div>
                 </div>

                 <button 
                    onClick={() => window.location.reload()}
                    className="w-full py-4 bg-white/10 hover:bg-white/20 border border-white/10 rounded-xl text-white font-bold transition-all flex items-center justify-center gap-2"
                 >
                    <RefreshCcw size={18} /> Restart Test
                 </button>
              </div>

              {/* Accuracy Card */}
              <div className="bg-gray-900/60 backdrop-blur-xl border border-white/10 rounded-3xl p-6 flex items-center justify-between">
                 <div>
                    <h3 className="text-gray-400 text-xs font-bold uppercase mb-1">Accuracy</h3>
                    <div className="text-3xl font-bold text-white">{res.accuracy}%</div>
                 </div>
                 <div className="h-12 w-12 rounded-full border-4 border-indigo-500 flex items-center justify-center bg-indigo-500/20">
                    <Target size={20} className="text-indigo-400"/>
                 </div>
              </div>
           </div>

           {/* Right Column: Detailed Analysis */}
           <div className="lg:col-span-7">
              <div className="flex justify-between items-center mb-6">
                 <h2 className="text-2xl font-bold text-white">Analysis</h2>
                 <button 
                   onClick={() => setShowExplanation(!showExplanation)}
                   className="text-sm font-medium text-indigo-400 hover:text-indigo-300 transition-colors"
                 >
                   {showExplanation ? 'Hide Details' : 'Show All Details'}
                 </button>
              </div>

              <div className="space-y-4 h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                 {questions.map((q, idx) => {
                    const myAns = answers[q.id];
                    const isCorrect = myAns === q.correctAnswer;
                    const isSkipped = !myAns;
                    
                    return (
                       <div key={idx} className="group bg-gray-900/40 border border-white/5 rounded-2xl p-5 hover:bg-gray-800/60 transition-colors">
                          <div className="flex items-start gap-4">
                             <div className={`mt-1 flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm
                                ${isCorrect ? 'bg-emerald-500/20 text-emer
